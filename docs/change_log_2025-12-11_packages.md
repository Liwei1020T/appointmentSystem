# Change Log â€” 2025-12-11 (Packages)

**Feature:** Phase 2.5 â€” å¥—é¤è´­ä¹°æµç¨‹  
**Status:** âœ… Completed  
**Developer:** AI Agent  

---

## ðŸ“ Summary

å®Œæˆäº†å¥—é¤è´­ä¹°çš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬å¥—é¤åˆ—è¡¨å±•ç¤ºã€è´­ä¹°æµç¨‹ï¼ˆç¡®è®¤â†’æ”¯ä»˜æ–¹å¼é€‰æ‹©â†’æ”¯ä»˜å¤„ç†â†’å®Œæˆï¼‰ã€æˆ‘çš„å¥—é¤ç®¡ç†é¡µé¢ã€‚ç”¨æˆ·å¯ä»¥æµè§ˆå¹¶è´­ä¹°ä¼˜æƒ å¥—é¤ï¼ŒæŸ¥çœ‹å·²è´­å¥—é¤çš„å‰©ä½™æ¬¡æ•°å’Œæœ‰æ•ˆæœŸï¼Œç³»ç»Ÿæ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ï¼ˆFPXã€TNGã€ä¿¡ç”¨å¡ã€åˆ°åº—æ”¯ä»˜ï¼‰ã€‚

---

## âœ¨ New Features

### 1. å¥—é¤æœåŠ¡å±‚æ‰©å±• (`src/services/packageService.ts`)

**æ–°å¢žæ–¹æ³•ï¼š**

- `purchasePackage(packageId)`: è´­ä¹°å¥—é¤å¹¶åˆ›å»ºç”¨æˆ·å¥—é¤è®°å½•
  - èŽ·å–å¥—é¤ä¿¡æ¯
  - è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆå¦‚æœ‰æœ‰æ•ˆæœŸï¼‰
  - åˆ›å»º user_packages è®°å½•
  - è¿”å›žç”¨æˆ·å¥—é¤æ•°æ®ï¼ˆåŒ…å«å¥—é¤è¯¦æƒ…ï¼‰

**åŠŸèƒ½ï¼š**
```typescript
// è´­ä¹°å¥—é¤
const { userPackage, error } = await purchasePackage(packageId);

// è¿”å›žæ•°æ®ç»“æž„
{
  user_id,
  package_id,
  remaining: package.times,
  expires_at: calculated_expiry_date,
  package: { id, name, times, price }
}
```

**è¿‡æœŸæ—¶é—´è®¡ç®—ï¼š**
```typescript
if (pkg.validity_days) {
  const expiryDate = new Date();
  expiryDate.setDate(expiryDate.getDate() + pkg.validity_days);
  expiresAt = expiryDate.toISOString();
}
```

**æ³¨æ„ï¼š** å½“å‰ä¸ºç›´æŽ¥æ•°æ®åº“æ“ä½œçš„ä¸´æ—¶å®žçŽ°ï¼Œç”Ÿäº§çŽ¯å¢ƒåº”é€šè¿‡ Edge Function å¤„ç†æ”¯ä»˜éªŒè¯å’Œå¥—é¤åˆ›å»ºã€‚

---

### 2. æ”¯ä»˜æœåŠ¡å±‚ (`src/services/paymentService.ts`)

**æ–°å¢žæœåŠ¡å±‚ï¼Œå°è£…æ”¯ä»˜ç›¸å…³é€»è¾‘ï¼š**

**æ ¸å¿ƒæ–¹æ³•ï¼š**

- `createPayment(amount, paymentMethod, orderId?)`: åˆ›å»ºæ”¯ä»˜è®°å½•
  - æ”¯æŒè®¢å•æ”¯ä»˜å’Œå¥—é¤è´­ä¹°
  - æ”¯ä»˜çŠ¶æ€åˆå§‹ä¸º 'pending'
  - è¿”å›žæ”¯ä»˜è®°å½• ID

- `getPaymentById(paymentId)`: èŽ·å–æ”¯ä»˜è¯¦æƒ…
  - éªŒè¯ç”¨æˆ·æƒé™
  - è¿”å›žæ”¯ä»˜å®Œæ•´ä¿¡æ¯

- `updatePaymentStatus(paymentId, status, transactionId?)`: æ›´æ–°æ”¯ä»˜çŠ¶æ€
  - æ”¯æŒçŠ¶æ€ï¼špending, completed, failed, refunded
  - å¯æ›´æ–°äº¤æ˜“å•å·

- `getUserPayments(limit?)`: èŽ·å–ç”¨æˆ·æ”¯ä»˜åŽ†å²
  - æŒ‰åˆ›å»ºæ—¶é—´å€’åº
  - å¯é™åˆ¶è¿”å›žæ•°é‡

- `simulatePayment(paymentId, success)`: æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†ï¼ˆæµ‹è¯•ç”¨ï¼‰
  - æ¨¡æ‹Ÿ 2 ç§’ç½‘ç»œå»¶è¿Ÿ
  - æˆåŠŸæ—¶ç”Ÿæˆäº¤æ˜“å•å·
  - æ›´æ–°æ”¯ä»˜çŠ¶æ€

**æ”¯ä»˜æ–¹å¼ç±»åž‹ï¼š**
```typescript
type PaymentMethod = 'fpx' | 'tng' | 'card' | 'cash';
```

**æ”¯ä»˜çŠ¶æ€ç±»åž‹ï¼š**
```typescript
type PaymentStatus = 'pending' | 'completed' | 'failed' | 'refunded';
```

**ç”¨é€”ï¼š**
- å¥—é¤è´­ä¹°æ”¯ä»˜
- è®¢å•æ”¯ä»˜ï¼ˆæœªæ¥ï¼‰
- æ”¯ä»˜åŽ†å²æŸ¥è¯¢
- æ”¯ä»˜çŠ¶æ€ç®¡ç†

---

### 3. å¥—é¤å¡ç‰‡ç»„ä»¶ (`src/components/PackageCard.tsx`)

**åŠŸèƒ½ï¼š**
- å±•ç¤ºå•ä¸ªå¥—é¤ä¿¡æ¯
- è®¡ç®—å¹¶æ˜¾ç¤ºèŠ‚çœé‡‘é¢
- æŽ¨èå¥—é¤é«˜äº®ï¼ˆ10æ¬¡å¥—é¤ï¼‰
- è´­ä¹°æŒ‰é’®

**æ˜¾ç¤ºå†…å®¹ï¼š**
- å¥—é¤åç§°
- æ¬¡æ•°ï¼ˆå¤§å­—ä½“å¼ºè°ƒï¼‰
- æ€»ä»·
- å¹³å‡æ¯æ¬¡ä»·æ ¼
- èŠ‚çœé‡‘é¢ä¸Žç™¾åˆ†æ¯”ï¼ˆç»¿è‰²æç¤ºæ¡†ï¼‰
- æœ‰æ•ˆæœŸ
- æè¿°ä¿¡æ¯
- è´­ä¹°æŒ‰é’®

**èŠ‚çœé‡‘é¢è®¡ç®—ï¼š**
```typescript
const pricePerTime = pkg.price / pkg.times;
const savings = (averagePrice * pkg.times) - pkg.price;
const savingsPercentage = ((savings / (averagePrice * pkg.times)) * 100).toFixed(0);
```

**æŽ¨èæ ‡ç­¾ï¼š**
- 10æ¬¡å¥—é¤æ˜¾ç¤º"ðŸ”¥ æŽ¨è"æ ‡ç­¾
- è“è‰²è¾¹æ¡†é«˜äº®
- è´­ä¹°æŒ‰é’®ä½¿ç”¨ä¸»è‰²

**Propsï¼š**
```typescript
interface PackageCardProps {
  package: Package;
  onPurchase: (pkg: Package) => void;
  disabled?: boolean;
  showSavings?: boolean;
  averagePrice?: number; // é»˜è®¤ RM50
}
```

---

### 4. å¥—é¤åˆ—è¡¨é¡µç»„ä»¶ (`src/features/packages/PackagesPage.tsx`)

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºæ‰€æœ‰å¯è´­ä¹°å¥—é¤
- å¥—é¤å¡ç‰‡ç½‘æ ¼å¸ƒå±€ï¼ˆå“åº”å¼ï¼‰
- ç‚¹å‡»è´­ä¹°è·³è½¬åˆ°è´­ä¹°æµç¨‹
- ç©ºçŠ¶æ€å¤„ç†
- è¯´æ˜Žå¡ç‰‡ï¼ˆä¸ºä»€ä¹ˆè´­ä¹°å¥—é¤ï¼‰
- è´­ä¹°é¡»çŸ¥

**é¡µé¢ç»“æž„ï¼š**

1. **é¡¶éƒ¨å¯¼èˆªæ **
   - è¿”å›žæŒ‰é’®
   - é¡µé¢æ ‡é¢˜

2. **è¯´æ˜Žå¡ç‰‡ï¼ˆè“è‰²æ¸å˜ï¼‰**
   - ä¸ºä»€ä¹ˆè´­ä¹°å¥—é¤
   - 4 ä¸ªä¼˜åŠ¿è¯´æ˜Ž

3. **å¥—é¤å¡ç‰‡ç½‘æ ¼**
   - å“åº”å¼å¸ƒå±€ï¼ˆ1/2/3åˆ—ï¼‰
   - ä½¿ç”¨ PackageCard ç»„ä»¶
   - ç‚¹å‡»è´­ä¹°è·³è½¬åˆ° `/packages/purchase?id={packageId}`

4. **è´­ä¹°é¡»çŸ¥å¡ç‰‡**
   - 5 æ¡è´­ä¹°æ³¨æ„äº‹é¡¹

**äº¤äº’ï¼š**
- ç‚¹å‡»å¥—é¤å¡ç‰‡"ç«‹å³è´­ä¹°"æŒ‰é’®
- è·³è½¬åˆ°è´­ä¹°æµç¨‹é¡µé¢ï¼Œæºå¸¦å¥—é¤ ID
- åŠ è½½çŠ¶æ€æ˜¾ç¤º Spinner
- é”™è¯¯æ—¶æ˜¾ç¤ºé‡è¯•æŒ‰é’®

**ç©ºçŠ¶æ€ï¼š**
- æ˜¾ç¤ºå›¾æ ‡å’Œæç¤ºæ–‡å­—
- "æš‚æ— å¯è´­ä¹°å¥—é¤"

---

### 5. å¥—é¤è´­ä¹°æµç¨‹ç»„ä»¶ (`src/features/packages/PackagePurchaseFlow.tsx`)

**åŠŸèƒ½ï¼š**
- 4 æ­¥è´­ä¹°æµç¨‹
- æ”¯ä»˜æ–¹å¼é€‰æ‹©
- æ”¯ä»˜å¤„ç†ä¸Žæ¨¡æ‹Ÿ
- è´­ä¹°æˆåŠŸæç¤º
- è‡ªåŠ¨è·³è½¬

**4 æ­¥æµç¨‹ï¼š**

**Step 1: ç¡®è®¤å¥—é¤ä¿¡æ¯**
- å¥—é¤åç§°ã€æ¬¡æ•°ã€æœ‰æ•ˆæœŸ
- æ€»ä»·æ˜¾ç¤ºï¼ˆè“è‰²åŠ ç²—ï¼‰
- å¥—é¤è¯´æ˜Žï¼ˆå¦‚æœ‰ï¼‰
- "ä¸‹ä¸€æ­¥"æŒ‰é’®

**Step 2: é€‰æ‹©æ”¯ä»˜æ–¹å¼**
- FPX ç½‘ä¸Šé“¶è¡Œ ðŸ¦
- Touch n Go eWallet ðŸ’°
- ä¿¡ç”¨å¡/å€Ÿè®°å¡ ðŸ’³
- åˆ°åº—æ”¯ä»˜ ðŸ’µ
- é€‰ä¸­çŠ¶æ€æ˜¾ç¤ºå¯¹å‹¾å›¾æ ‡
- "ç¡®è®¤æ”¯ä»˜"æŒ‰é’®

**Step 3: æ”¯ä»˜å¤„ç†ä¸­**
- Spinner åŠ è½½åŠ¨ç”»
- "æ­£åœ¨å¤„ç†æ”¯ä»˜..."æç¤º
- ç¦æ­¢è¿”å›ž

**Step 4: è´­ä¹°æˆåŠŸ**
- ç»¿è‰²å¯¹å‹¾å›¾æ ‡
- "è´­ä¹°æˆåŠŸï¼"æç¤º
- 3 ç§’åŽè‡ªåŠ¨è·³è½¬åˆ°æˆ‘çš„å¥—é¤

**è¿›åº¦æŒ‡ç¤ºå™¨ï¼š**
- 4 ä¸ªåœ†åœˆèŠ‚ç‚¹
- å®Œæˆçš„æ­¥éª¤æ˜¾ç¤ºå¯¹å‹¾
- å½“å‰æ­¥éª¤è“è‰²é«˜äº®
- è¿žæŽ¥çº¿æ˜¾ç¤ºè¿›åº¦

**æ”¯ä»˜å¤„ç†é€»è¾‘ï¼š**
```typescript
1. åˆ›å»ºæ”¯ä»˜è®°å½• (createPayment)
2. åˆ°åº—æ”¯ä»˜ï¼šç›´æŽ¥åˆ›å»ºå¥—é¤
3. å…¶ä»–æ–¹å¼ï¼šæ¨¡æ‹Ÿæ”¯ä»˜ç½‘å…³ (simulatePayment)
4. æ”¯ä»˜æˆåŠŸåŽåˆ›å»ºç”¨æˆ·å¥—é¤ (purchasePackage)
5. æ˜¾ç¤ºæˆåŠŸé¡µé¢
6. 3ç§’åŽè·³è½¬åˆ° /my-packages
```

**Propsï¼š**
- ä»Ž URL å‚æ•°èŽ·å– `packageId`
- æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
- æœªç™»å½•è·³è½¬åˆ°ç™»å½•é¡µ

---

### 6. æˆ‘çš„å¥—é¤é¡µç»„ä»¶ (`src/features/packages/MyPackagesPage.tsx`)

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºç”¨æˆ·å·²è´­å¥—é¤
- æœ‰æ•ˆå¥—é¤/å·²è¿‡æœŸå¥—é¤åˆ‡æ¢
- å‰©ä½™æ¬¡æ•°ç»Ÿè®¡
- ä½¿ç”¨è¿›åº¦æ¡
- è¿‡æœŸæé†’
- ç©ºçŠ¶æ€å¼•å¯¼

**é¡µé¢ç»“æž„ï¼š**

1. **ç»Ÿè®¡å¡ç‰‡ï¼ˆè“è‰²æ¸å˜ï¼‰**
   - å‰©ä½™æ€»æ¬¡æ•°
   - æœ‰æ•ˆå¥—é¤æ•°é‡

2. **åˆ‡æ¢æŒ‰é’®**
   - æœ‰æ•ˆå¥—é¤ (count)
   - å·²è¿‡æœŸ (count)

3. **å¥—é¤å¡ç‰‡åˆ—è¡¨**
   - å¥—é¤åç§°
   - è´­ä¹°æ—¶é—´
   - ä½¿ç”¨è¿›åº¦æ¡
   - å‰©ä½™æ¬¡æ•°
   - æœ‰æ•ˆæœŸå€’è®¡æ—¶
   - è¿‡æœŸæ ‡è¯†

**å¥—é¤å¡ç‰‡æ˜¾ç¤ºå†…å®¹ï¼š**
- å¥—é¤åç§° + è´­ä¹°æ—¶é—´
- ä½¿ç”¨è¿›åº¦æ¡ï¼ˆè“è‰²/ç°è‰²ï¼‰
- å·²ç”¨æ¬¡æ•° / æ€»æ¬¡æ•°
- å‰©ä½™æ¬¡æ•°ï¼ˆå¤§å­—ä½“ï¼‰
- æœ‰æ•ˆæœŸå‰©ä½™å¤©æ•° æˆ– "æ°¸ä¹…æœ‰æ•ˆ"
- è¿‡æœŸæé†’ï¼ˆ7å¤©å†…æ˜¾ç¤ºæ©™è‰²æç¤ºï¼‰

**æœ‰æ•ˆæœŸæ˜¾ç¤ºï¼š**
- å‰©ä½™ X å¤©ï¼ˆç»¿è‰²/æ©™è‰²ï¼‰
- å·²è¿‡æœŸï¼ˆç°è‰²ï¼‰
- æ°¸ä¹…æœ‰æ•ˆï¼ˆç»¿è‰²ï¼‰

**è¿‡æœŸæé†’ï¼š**
- å‰©ä½™ â‰¤7 å¤©ï¼šæ˜¾ç¤ºæ©™è‰²è­¦å‘Šæ¡†
- "å¥—é¤å³å°†è¿‡æœŸï¼Œè¯·å°½å¿«ä½¿ç”¨"

**ç©ºçŠ¶æ€ï¼š**
- æœ‰æ•ˆå¥—é¤ç©ºï¼šå¼•å¯¼è´­ä¹°å¥—é¤
- å·²è¿‡æœŸç©ºï¼šæ˜¾ç¤º"æ— å·²è¿‡æœŸå¥—é¤"

**ä½¿ç”¨è¯´æ˜Žï¼š**
- é¢„çº¦æ—¶å¯é€‰æ‹©ä½¿ç”¨å¥—é¤æŠµæ‰£
- ä¼˜å…ˆä½¿ç”¨å³å°†è¿‡æœŸçš„å¥—é¤
- è¿‡æœŸåŽå‰©ä½™æ¬¡æ•°å°†å¤±æ•ˆ
- å¥—é¤ä¸å¯è½¬è®©æˆ–é€€æ¬¾

---

### 7. è·¯ç”±é¡µé¢ (3ä¸ª)

**`src/app/packages/page.tsx`**
- è·¯å¾„ï¼š`/packages`
- æ¸²æŸ“ï¼šPackagesPage ç»„ä»¶
- å…ƒæ•°æ®ï¼šè´­ä¹°å¥—é¤ | String Service Platform

**`src/app/packages/purchase/page.tsx`**
- è·¯å¾„ï¼š`/packages/purchase?id={packageId}`
- æ¸²æŸ“ï¼šPackagePurchaseFlow ç»„ä»¶
- å…ƒæ•°æ®ï¼šè´­ä¹°å¥—é¤ | String Service Platform

**`src/app/my-packages/page.tsx`**
- è·¯å¾„ï¼š`/my-packages`
- æ¸²æŸ“ï¼šMyPackagesPage ç»„ä»¶
- å…ƒæ•°æ®ï¼šæˆ‘çš„å¥—é¤ | String Service Platform

---

## ðŸ“Š Database Changes

**æ— æ•°æ®åº“ç»“æž„å˜æ›´**

ä½¿ç”¨çŽ°æœ‰è¡¨ç»“æž„ï¼š
- `packages`: å¥—é¤æ¨¡æ¿è¡¨
- `user_packages`: ç”¨æˆ·å¥—é¤è¡¨
- `payments`: æ”¯ä»˜è®°å½•è¡¨

---

## ðŸ”Œ API Updates

**packageService.ts æ–°å¢žï¼š**

- `purchasePackage(packageId)` â†’ `{ userPackage, error }`
  - åˆ›å»ºç”¨æˆ·å¥—é¤è®°å½•
  - è®¡ç®—è¿‡æœŸæ—¶é—´
  - è¿”å›žå¥—é¤æ•°æ®ï¼ˆå« package è¯¦æƒ…ï¼‰

**paymentService.ts æ–°å¢žæœåŠ¡å±‚ï¼š**

- `createPayment(amount, paymentMethod, orderId?)` â†’ `{ payment, error }`
- `getPaymentById(paymentId)` â†’ `{ payment, error }`
- `updatePaymentStatus(paymentId, status, transactionId?)` â†’ `{ error }`
- `getUserPayments(limit?)` â†’ `{ payments, error }`
- `simulatePayment(paymentId, success)` â†’ `{ error }`

**utils.ts æ–°å¢žå·¥å…·å‡½æ•°ï¼š**

- `calculateDaysRemaining(date)` â†’ `number | null`
  - è®¡ç®—è·ç¦»æŒ‡å®šæ—¥æœŸçš„å‰©ä½™å¤©æ•°
  - ç”¨äºŽå¥—é¤æœ‰æ•ˆæœŸå€’è®¡æ—¶

---

## ðŸŽ¨ UI/UX Updates

### æ–°å¢žç»„ä»¶

**PackageCard:**
- å¡ç‰‡å¼è®¾è®¡
- æŽ¨èå¥—é¤é«˜äº®ï¼ˆè“è‰²è¾¹æ¡† + æ ‡ç­¾ï¼‰
- èŠ‚çœé‡‘é¢ç»¿è‰²æç¤ºæ¡†
- å“åº”å¼å¸ƒå±€

**PackagesPage:**
- è¯´æ˜Žå¡ç‰‡ï¼ˆè“è‰²æ¸å˜èƒŒæ™¯ï¼‰
- ç½‘æ ¼å¸ƒå±€å¥—é¤åˆ—è¡¨
- è´­ä¹°é¡»çŸ¥å¡ç‰‡
- ç©ºçŠ¶æ€å‹å¥½æç¤º

**PackagePurchaseFlow:**
- 4 æ­¥è¿›åº¦æŒ‡ç¤ºå™¨
- æ”¯ä»˜æ–¹å¼é€‰æ‹©ï¼ˆå›¾æ ‡ + æè¿°ï¼‰
- æ”¯ä»˜å¤„ç†åŠ è½½åŠ¨ç”»
- æˆåŠŸé¡µé¢ï¼ˆç»¿è‰²å¯¹å‹¾ï¼‰
- åº•éƒ¨å›ºå®šæ“ä½œæ 

**MyPackagesPage:**
- ç»Ÿè®¡å¡ç‰‡ï¼ˆæ¸å˜èƒŒæ™¯ï¼‰
- åˆ‡æ¢æŒ‰é’®ï¼ˆæœ‰æ•ˆ/è¿‡æœŸï¼‰
- è¿›åº¦æ¡å¯è§†åŒ–
- è¿‡æœŸæé†’ï¼ˆæ©™è‰²è­¦å‘Šï¼‰
- ä½¿ç”¨è¯´æ˜Žå¡ç‰‡

### äº¤äº’ä¼˜åŒ–

- **è´­ä¹°æµç¨‹**ï¼š4æ­¥å‘å¯¼ï¼Œæ­¥éª¤æ¸…æ™°
- **æ”¯ä»˜æ–¹å¼**ï¼šå¡ç‰‡å¼é€‰æ‹©ï¼Œå¤§è§¦æ‘¸åŒºåŸŸ
- **è¿›åº¦åé¦ˆ**ï¼šå®žæ—¶æ˜¾ç¤ºå¤„ç†çŠ¶æ€
- **è‡ªåŠ¨è·³è½¬**ï¼šæˆåŠŸåŽ3ç§’è‡ªåŠ¨è·³è½¬
- **ç©ºçŠ¶æ€**ï¼šå¼•å¯¼ç”¨æˆ·è´­ä¹°æˆ–æŸ¥çœ‹å…¶ä»–å†…å®¹

### è§†è§‰è®¾è®¡

- **é¢œè‰²ä½“ç³»**ï¼šè“è‰²ä¸»é¢˜ï¼Œç»¿è‰²æç¤ºï¼Œæ©™è‰²è­¦å‘Š
- **æ¸å˜èƒŒæ™¯**ï¼šç»Ÿè®¡å¡ç‰‡å’Œè¯´æ˜Žå¡ç‰‡
- **å›¾æ ‡ä½¿ç”¨**ï¼šemoji + SVG ç»“åˆ
- **è¿›åº¦æ¡**ï¼šè“è‰²æ´»è·ƒï¼Œç°è‰²å®Œæˆ
- **å¾½ç« **ï¼šæŽ¨èæ ‡ç­¾ã€è¿‡æœŸæ ‡è¯†

---

## ðŸ§ª Testing Recommendations

### 1. å¥—é¤åˆ—è¡¨æµ‹è¯•

- âœ… æ˜¾ç¤ºæ‰€æœ‰å¯è´­ä¹°å¥—é¤
- âœ… æŽ¨èå¥—é¤é«˜äº®æ˜¾ç¤º
- âœ… èŠ‚çœé‡‘é¢è®¡ç®—æ­£ç¡®
- âœ… ç‚¹å‡»è´­ä¹°è·³è½¬æ­£ç¡®
- âœ… ç©ºçŠ¶æ€æ˜¾ç¤º

### 2. è´­ä¹°æµç¨‹æµ‹è¯•

- âœ… 4æ­¥æµç¨‹æ­£å¸¸è¿›è¡Œ
- âœ… å¥—é¤ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
- âœ… æ”¯ä»˜æ–¹å¼é€‰æ‹©
- âœ… æ”¯ä»˜å¤„ç†æ¨¡æ‹Ÿ
- âœ… åˆ°åº—æ”¯ä»˜ç›´æŽ¥åˆ›å»ºå¥—é¤
- âœ… è´­ä¹°æˆåŠŸåŽåˆ›å»ºç”¨æˆ·å¥—é¤
- âœ… è‡ªåŠ¨è·³è½¬åˆ°æˆ‘çš„å¥—é¤

### 3. æˆ‘çš„å¥—é¤æµ‹è¯•

- âœ… æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·å¥—é¤
- âœ… æœ‰æ•ˆ/è¿‡æœŸå¥—é¤åˆ‡æ¢
- âœ… å‰©ä½™æ¬¡æ•°ç»Ÿè®¡æ­£ç¡®
- âœ… ä½¿ç”¨è¿›åº¦æ¡å‡†ç¡®
- âœ… æœ‰æ•ˆæœŸå€’è®¡æ—¶æ­£ç¡®
- âœ… è¿‡æœŸæé†’æ˜¾ç¤º
- âœ… ç©ºçŠ¶æ€å¼•å¯¼

### 4. æ”¯ä»˜æœåŠ¡æµ‹è¯•

- âœ… åˆ›å»ºæ”¯ä»˜è®°å½•
- âœ… æ›´æ–°æ”¯ä»˜çŠ¶æ€
- âœ… æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
- âœ… æ”¯ä»˜åŽ†å²æŸ¥è¯¢

### 5. è¾¹ç•Œæƒ…å†µæµ‹è¯•

- âœ… å¥—é¤ä¸å­˜åœ¨
- âœ… ç”¨æˆ·æœªç™»å½•
- âœ… æ”¯ä»˜å¤±è´¥
- âœ… ç½‘ç»œé”™è¯¯
- âœ… å¥—é¤å·²è¿‡æœŸ
- âœ… æ— å¯ç”¨å¥—é¤

---

## ðŸ“ Implementation Notes

### æ”¯ä»˜å¤„ç†æœºåˆ¶

**å½“å‰å®žçŽ°ï¼ˆä¸´æ—¶ï¼‰ï¼š**

```typescript
// 1. åˆ›å»ºæ”¯ä»˜è®°å½•
const { payment } = await createPayment(pkg.price, paymentMethod);

// 2. æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆ2ç§’å»¶è¿Ÿï¼‰
await simulatePayment(payment.id, true);

// 3. åˆ›å»ºç”¨æˆ·å¥—é¤
await purchasePackage(pkg.id);
```

**ç”Ÿäº§çŽ¯å¢ƒåº”æ”¹ä¸ºï¼š**

```typescript
// 1. è°ƒç”¨ Edge Function åˆ›å»ºæ”¯ä»˜ä¼šè¯
POST /functions/v1/create-payment-session
{
  package_id,
  payment_method
}

// 2. æ ¹æ®æ”¯ä»˜æ–¹å¼è·³è½¬
if (fpx/tng/card) {
  // è·³è½¬åˆ°æ”¯ä»˜ç½‘å…³
  window.location.href = payment_gateway_url;
} else if (cash) {
  // ç›´æŽ¥åˆ›å»ºå¥—é¤ï¼ˆåŽå°å®¡æ ¸ï¼‰
}

// 3. æ”¯ä»˜ç½‘å…³å›žè°ƒ
POST /functions/v1/payment-webhook
{
  payment_id,
  status,
  transaction_id
}

// 4. Webhook éªŒè¯æ”¯ä»˜åŽåˆ›å»ºå¥—é¤
```

---

### å¥—é¤æœ‰æ•ˆæœŸè®¡ç®—

**é€»è¾‘ï¼š**
```typescript
// è´­ä¹°æ—¶è®¡ç®—è¿‡æœŸæ—¥æœŸ
if (pkg.validity_days) {
  const expiryDate = new Date();
  expiryDate.setDate(expiryDate.getDate() + validity_days);
  expires_at = expiryDate.toISOString();
} else {
  expires_at = null; // æ°¸ä¹…æœ‰æ•ˆ
}
```

**æ˜¾ç¤ºæ—¶è®¡ç®—å‰©ä½™å¤©æ•°ï¼š**
```typescript
const daysRemaining = calculateDaysRemaining(pkg.expires_at);

if (daysRemaining === null) {
  display: "æ°¸ä¹…æœ‰æ•ˆ"
} else if (daysRemaining > 0) {
  display: `å‰©ä½™ ${daysRemaining} å¤©`
} else {
  display: "å·²è¿‡æœŸ"
}
```

---

### å¥—é¤ä½¿ç”¨ä¼˜å…ˆçº§

**å·²åœ¨ packageService ä¸­å®žçŽ°ï¼š**

```typescript
// getPriorityPackage() æŽ’åºé€»è¾‘
packages.sort((a, b) => {
  // 1. ä¼˜å…ˆä½¿ç”¨å¿«è¿‡æœŸçš„
  if (a.expires_at && b.expires_at) {
    if (dateA < dateB) return -1;
  }
  
  // 2. å…¶æ¬¡æŒ‰å‰©ä½™æ¬¡æ•°ä»Žå°‘åˆ°å¤š
  return a.remaining - b.remaining;
});
```

**é¢„çº¦æ—¶ä½¿ç”¨ï¼š**
- èŽ·å–ä¼˜å…ˆå¥—é¤
- æç¤ºç”¨æˆ·ä½¿ç”¨å³å°†è¿‡æœŸçš„å¥—é¤
- æ‰£å‡å¥—é¤æ¬¡æ•°

---

## ðŸ“ Updated Files

### æ–°å¢žæ–‡ä»¶

1. `src/services/paymentService.ts` (195è¡Œ) - æ”¯ä»˜æœåŠ¡å±‚
2. `src/components/PackageCard.tsx` (128è¡Œ) - å¥—é¤å¡ç‰‡ç»„ä»¶
3. `src/features/packages/PackagesPage.tsx` (141è¡Œ) - å¥—é¤åˆ—è¡¨é¡µ
4. `src/features/packages/PackagePurchaseFlow.tsx` (341è¡Œ) - è´­ä¹°æµç¨‹ç»„ä»¶
5. `src/features/packages/MyPackagesPage.tsx` (227è¡Œ) - æˆ‘çš„å¥—é¤é¡µ
6. `src/app/packages/page.tsx` (14è¡Œ) - å¥—é¤åˆ—è¡¨è·¯ç”±
7. `src/app/packages/purchase/page.tsx` (14è¡Œ) - è´­ä¹°æµç¨‹è·¯ç”±
8. `src/app/my-packages/page.tsx` (14è¡Œ) - æˆ‘çš„å¥—é¤è·¯ç”±

### ä¿®æ”¹æ–‡ä»¶

1. `src/services/packageService.ts`
   - æ–°å¢ž `purchasePackage()` æ–¹æ³•

2. `src/lib/utils.ts`
   - æ–°å¢ž `calculateDaysRemaining()` å·¥å…·å‡½æ•°

---

## ðŸŽ¯ Impact Analysis

### å½±å“èŒƒå›´

**æ­£é¢å½±å“ï¼š**
- âœ… ç”¨æˆ·å¯åœ¨çº¿è´­ä¹°å¥—é¤
- âœ… æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼
- âœ… å¥—é¤ç®¡ç†å¯è§†åŒ–
- âœ… æœ‰æ•ˆæœŸæé†’æœºåˆ¶
- âœ… è´­ä¹°æµç¨‹ä½“éªŒä¼˜åŒ–

**æ½œåœ¨é£Žé™©ï¼š**
- âš ï¸ å½“å‰ä¸ºæ¨¡æ‹Ÿæ”¯ä»˜ï¼ŒæœªæŽ¥å…¥çœŸå®žç½‘å…³
- âš ï¸ å¥—é¤è´­ä¹°æœªç»æ”¯ä»˜éªŒè¯ï¼ˆä¸´æ—¶å®žçŽ°ï¼‰
- âš ï¸ æ— è®¢å•ç¼–å·å’Œå‘ç¥¨ç”Ÿæˆ
- âš ï¸ æ— é€€æ¬¾æœºåˆ¶

**ç¼“è§£æŽªæ–½ï¼š**
- å°½å¿«é›†æˆçœŸå®žæ”¯ä»˜ç½‘å…³ï¼ˆFPX/TNG/Stripeï¼‰
- é€šè¿‡ Edge Function éªŒè¯æ”¯ä»˜
- æ·»åŠ æ”¯ä»˜å‡­è¯ä¸Šä¼ ï¼ˆåˆ°åº—æ”¯ä»˜ï¼‰
- å®žçŽ°é€€æ¬¾æµç¨‹ï¼ˆé™ç‰¹æ®Šæƒ…å†µï¼‰

---

## ðŸ”— Related Features

**ä¸ŽçŽ°æœ‰åŠŸèƒ½çš„å…³è”ï¼š**

1. **é¢„çº¦æµç¨‹ (Phase 2.3)**
   - é¢„çº¦æ—¶å¯é€‰æ‹©ä½¿ç”¨å¥—é¤æŠµæ‰£
   - è‡ªåŠ¨é€‰æ‹©ä¼˜å…ˆå¥—é¤
   - æ‰£å‡å¥—é¤æ¬¡æ•°

2. **é¦–é¡µ (Phase 2.2)**
   - æ˜¾ç¤ºå¥—é¤æ‘˜è¦ï¼ˆå‰©ä½™æ€»æ¬¡æ•°ï¼‰
   - PackageSummary ç»„ä»¶
   - å¿«æ·è´­ä¹°å¥—é¤æŒ‰é’®

3. **è®¤è¯ç³»ç»Ÿ (Phase 2.1)**
   - æ‰€æœ‰å¥—é¤æ“ä½œéœ€è¦ç™»å½•
   - ä½¿ç”¨ AuthContext

**æœªæ¥é›†æˆï¼š**

1. **æ”¯ä»˜ç½‘å…³ (Phase 4)**
   - FPX é›†æˆï¼ˆé©¬æ¥è¥¿äºšç½‘é“¶ï¼‰
   - Touch n Go eWallet
   - Stripe/ä¿¡ç”¨å¡æ”¯ä»˜

2. **ç§¯åˆ†ç³»ç»Ÿ (Phase 2.6)**
   - è´­ä¹°å¥—é¤èµ é€ç§¯åˆ†
   - ç§¯åˆ†å…‘æ¢å¥—é¤ä¼˜æƒ åˆ¸

3. **é€šçŸ¥ç³»ç»Ÿ (Phase 4)**
   - è´­ä¹°æˆåŠŸé€šçŸ¥
   - å¥—é¤å³å°†è¿‡æœŸæé†’
   - å¥—é¤å·²ä½¿ç”¨å®Œæé†’

---

## âœ… Checklist

- [x] æ‰©å±• packageServiceï¼ˆpurchasePackageï¼‰
- [x] åˆ›å»º paymentService æœåŠ¡å±‚
- [x] å¥—é¤å¡ç‰‡ç»„ä»¶
- [x] å¥—é¤åˆ—è¡¨é¡µç»„ä»¶
- [x] å¥—é¤è´­ä¹°æµç¨‹ç»„ä»¶
- [x] æˆ‘çš„å¥—é¤é¡µç»„ä»¶
- [x] å¥—é¤åˆ—è¡¨è·¯ç”±é¡µé¢
- [x] è´­ä¹°æµç¨‹è·¯ç”±é¡µé¢
- [x] æˆ‘çš„å¥—é¤è·¯ç”±é¡µé¢
- [x] Change Log æ–‡æ¡£
- [ ] é›†æˆçœŸå®žæ”¯ä»˜ç½‘å…³ï¼ˆå¾…åŽç»­ï¼‰
- [ ] æ”¯ä»˜å‡­è¯ä¸Šä¼ ï¼ˆå¾…åŽç»­ï¼‰
- [ ] å‘ç¥¨ç”ŸæˆåŠŸèƒ½ï¼ˆå¾…åŽç»­ï¼‰

---

## ðŸš€ Next Steps

**Phase 2.6: ç§¯åˆ†ä¸Žä¼˜æƒ åˆ¸ç®¡ç†**
- ç§¯åˆ†åŽ†å²é¡µï¼ˆpoints_log è¡¨ï¼‰
- ç§¯åˆ†èŽ·å¾—è§„åˆ™å±•ç¤º
- ä¼˜æƒ åˆ¸å…‘æ¢é¡µï¼ˆä½¿ç”¨ç§¯åˆ†å…‘æ¢ï¼‰
- æˆ‘çš„ä¼˜æƒ åˆ¸é¡µï¼ˆå·²æ‹¥æœ‰ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼‰
- ä¼˜æƒ åˆ¸è¯¦æƒ…ä¸Žä½¿ç”¨è¯´æ˜Ž

**Phase 3: ç®¡ç†åŽå°**
- ç®¡ç†å‘˜ç™»å½•ä¸Žæƒé™
- å¥—é¤ç®¡ç†ï¼ˆCRUDï¼‰
- æ”¯ä»˜è®°å½•æŸ¥çœ‹
- ç”¨æˆ·å¥—é¤ç®¡ç†
- è´¢åŠ¡æŠ¥è¡¨

**æ”¯ä»˜åŠŸèƒ½å¢žå¼ºï¼ˆåŽç»­ä¼˜åŒ–ï¼‰ï¼š**
- é›†æˆ FPX ç½‘å…³
- é›†æˆ Touch n Go eWallet
- é›†æˆ Stripeï¼ˆå›½é™…å¡ï¼‰
- æ”¯ä»˜å‡­è¯ä¸Šä¼ ï¼ˆåˆ°åº—æ”¯ä»˜ï¼‰
- æ”¯ä»˜å¤±è´¥é‡è¯•æœºåˆ¶
- é€€æ¬¾ç”³è¯·ä¸Žå¤„ç†
- å‘ç¥¨ç”Ÿæˆä¸Žä¸‹è½½

**å¥—é¤åŠŸèƒ½å¢žå¼ºï¼š**
- å¥—é¤èµ é€åŠŸèƒ½
- å¥—é¤è½¬è®©åŠŸèƒ½
- ç»„åˆå¥—é¤ï¼ˆå¤šç§æœåŠ¡ï¼‰
- é™æ—¶ä¼˜æƒ å¥—é¤
- å¥—é¤ä½¿ç”¨åŽ†å²è¯¦æƒ…

---

## ðŸ“ž Support

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. `docs/System-Design-Document.md` - ç³»ç»Ÿæž¶æž„è®¾è®¡
2. `docs/UI-Design-Guide.md` - UI è®¾è®¡è§„èŒƒ
3. `docs/change_log_2025-12-11_booking.md` - é¢„çº¦æµç¨‹æ–‡æ¡£
4. `docs/change_log_2025-12-11_orders.md` - è®¢å•ç®¡ç†æ–‡æ¡£

---

**Change Log Document**  
**Generated:** 2025-12-11  
**Version:** 1.0  
**Status:** âœ… Phase 2.5 Completed
